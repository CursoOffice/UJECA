<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Listado de Inscritos</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style1.css">
<link rel="alternate" href="rss.xml" type="application/rss+xml" title="RSS">
</head>

<body>
<header class="topbar">
    <div class="topbar-content">

        <div class="logo-area">
            <img src="img/logo.png" class="logo">
            <div class="titulo">
                <strong>Congreso Juvenil 2026</strong>
                <span>Circuito 2 - Zona 6</span>
            </div>
        </div>

        <nav class="menu">
            <a href="home.html">Inicio</a>
            <a href="form.html">Registrarse</a>
            <a href="index.html">Contacto</a>
        </nav>

    </div>
</header>
<div class="panel">

<h1>Listado Oficial de Inscritos</h1>

<div class="search">
<input type="text" id="busqueda" placeholder="Buscar...">
<button id="descargar" class="btn-download">Descargar Excel</button>
<button id="adminBtn" class="admin-btn">Modo Admin</button>
<div class="count" id="contador">Cargando...</div>
</div>

<div class="tabla-contenedor">
    <div id="tabla" class="loading">Cargando inscritos...</div>
</div>


</div>


<script>
    function formatearFecha(fechaISO){
    if(!fechaISO) return "";

    const fecha = new Date(fechaISO);

    return fecha.toLocaleString("es-CO",{
        day:"2-digit",
        month:"2-digit",
        year:"numeric",
        hour:"2-digit",
        minute:"2-digit",
        hour12:true
    });
}


const API="https://script.google.com/macros/s/AKfycbwHLRkZSCFXKg5qjWQK1VmrHO2maLFtqx_p0xpe_K-87iYHePmSZKkh2gYX4kkDjGC-/exec";

let datosGlobal=[];
let adminActivo=false;
const PASSWORD="admin2026";

/* ACTIVAR ADMIN */
document.getElementById("adminBtn").addEventListener("click",()=>{
let clave=prompt("Ingrese contraseña de administrador:");
if(clave===PASSWORD){
adminActivo=true;
alert("Modo administrador activado");
renderTabla(datosGlobal);
}else{
alert("Contraseña incorrecta");
}
});

/* RENDER TABLA */
function renderTabla(data){

if(!data || data.length===0){
document.getElementById("tabla").innerHTML="No hay registros";
document.getElementById("contador").innerText="0 inscritos";
return;
}

let headers=Object.keys(data[0]);

let html="<table><thead><tr>";
headers.forEach(h=>html+=`<th>${h}</th>`);
if(adminActivo) html+="<th>Eliminar</th>";
html+="</tr></thead><tbody>";

for(let i=0;i<data.length;i++){
let row=data[i];
html+="<tr>";
headers.forEach(h=>{
let valor=row[h]??"";
if(h.toLowerCase().includes("fecha")){
valor=formatearFecha(valor);
}
html+=`<td>${valor}</td>`;
});
if(adminActivo){
html+=`<td><button class="btn-delete" onclick="eliminarRegistro(${i})">X</button></td>`;
}
html+="</tr>";
}

html+="</tbody></table>";

document.getElementById("tabla").innerHTML=html;
document.getElementById("contador").innerText=data.length+" inscritos";
}

/* BUSCADOR */
document.getElementById("busqueda").addEventListener("input",e=>{
const texto=e.target.value.toLowerCase();

const filtrados=datosGlobal.filter(row=>
Object.values(row).some(val=>
String(val).toLowerCase().includes(texto)
)
);

renderTabla(filtrados);
});

/* DESCARGAR CSV */
document.getElementById("descargar").addEventListener("click",()=>{
if(datosGlobal.length===0) return alert("No hay datos");

let headers=Object.keys(datosGlobal[0]);
let csv=headers.join(",")+"\n";

datosGlobal.forEach(row=>{
let fila=headers.map(h=>`"${row[h]??""}"`);
csv+=fila.join(",")+"\n";
});

let blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
let link=document.createElement("a");
link.href=URL.createObjectURL(blob);
link.download="inscritos_2026.csv";
link.click();
});

/* ELIMINAR */
function eliminarRegistro(index){

if(!confirm("¿Eliminar este registro?")) return;

fetch(API,{
method:"POST",
body:JSON.stringify({
accion:"eliminar",
index:index
})
})
.then(r=>r.json())
.then(res=>{
if(res.resultado=="ok"){
alert("Registro eliminado");
location.reload();
}else{
alert("Error al eliminar");
}
});
}

/* CARGAR DATOS */
function cargarDatos(data){
datosGlobal=data.reverse();
renderTabla(datosGlobal);
}

const script=document.createElement("script");
script.src=API+"?callback=cargarDatos";
document.body.appendChild(script);

</script>

</body>
</html>
